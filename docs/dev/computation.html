<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Computation Pipeline &mdash; Blaze 0.7.2 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap-2.2.1.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap-responsive-2.2.1.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.7.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-2.2.1.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-scrollspy.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-affix.js"></script>
    <link rel="top" title="Blaze 0.7.2 documentation" href="index.html" />
    <link rel="prev" title="Expressions and Computation" href="expr-compute-dev.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

<div class="container">
  <!-- This is copied from /web, find better solution -->
  <div class="masthead">
    <ul class="nav nav-pills pull-right">
        <li>
            <a href="index.html"><i class="icon-home"></i> Blaze</a>
        </li>

        <li>
            <a href="quickstart.html"><i class="icon-ok"></i> Examples</a>
        </li>

        <li>
            <a href="api.html"><i class="icon-download"></i> API</a>
        </li>

        <li>
            <a href="people.html"><i class="icon-user"></i> People</a>
        </li>

        <li>
            <a href="http://github.com/ContinuumIO/blaze"><i class="icon-download"></i> Source</a>
        </li>

        <li>
            <a href="http://groups.google.com/a/continuum.io/forum/#!forum/blaze-dev"><i class="icon-envelope"></i> Mailing List</a>
        </li>
<form class="navbar-search pull-right" style="margin-bottom:-3px;" action="search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
    </ul>
    <h3 class="muted"><img src="_static/img/logo.png">Blaze</h3>
  </div>

  <hr>

  <div class="row">
      <div class="span3">
         <ul id="nav" class="nav nav-list" data-spy="affix" data-offset-top="200"><li><a href="index.html"><b>Index</b></a></li>
<ul>
<li><a class="reference internal" href="#">Computation Pipeline</a><ul>
<li><a class="reference internal" href="#problem">Problem</a></li>
<li><a class="reference internal" href="#simple-solution">Simple Solution</a></li>
<li><a class="reference internal" href="#complications">Complications</a></li>
<li><a class="reference internal" href="#optimize-expr-data-expr"><tt class="docutils literal"><span class="pre">optimize</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">expr</span></tt></a></li>
<li><a class="reference internal" href="#pre-compute-expr-data-data"><tt class="docutils literal"><span class="pre">pre_compute</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></a></li>
<li><a class="reference internal" href="#post-compute-expr-data-data"><tt class="docutils literal"><span class="pre">post_compute</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></a></li>
<li><a class="reference internal" href="#compute-up-expr-data-data"><tt class="docutils literal"><span class="pre">compute_up</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></a></li>
<li><a class="reference internal" href="#compute-down-expr-data-data"><tt class="docutils literal"><span class="pre">compute_down</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></a></li>
<li><a class="reference internal" href="#full-pipeline">Full Pipeline</a></li>
<li><a class="reference internal" href="#history">History</a></li>
</ul>
</li>
</ul>

         </ul>
      </div>
      <div class="span9">
          
  <div class="section" id="computation-pipeline">
<h1>Computation Pipeline<a class="headerlink" href="#computation-pipeline" title="Permalink to this headline">¶</a></h1>
<p>This is a developer level document.  It conveys some of the design decisions
around the use of expressions and their lowering to computational backends.  It
is intended for developers.  It is not necessary to understand this document in
order to use Blaze.</p>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>Given an expression:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;5 * int&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;5 * int&#39;</span><span class="p">)</span>
<span class="n">expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>And data arranged into a namespace</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">])</span>
<span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>

<span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ydata</span><span class="p">}</span>
</pre></div>
</div>
<p>Our goal is to produce the result implied by the expression</p>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">205</span>
</pre></div>
</div>
<p>Using many small functions defined for each backend to do small pieces of this
computation</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@dispatch</span><span class="p">(</span><span class="n">blaze</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_up</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="simple-solution">
<h2>Simple Solution<a class="headerlink" href="#simple-solution" title="Permalink to this headline">¶</a></h2>
<p>A simple solution to this problem is to walk from the leaves of the expression
tree, applying <tt class="docutils literal"><span class="pre">compute_up</span></tt> functions to data resources until we reach the
top.  In cases like the above example this suffices.  This is called a <em>bottom
up</em> traversal.</p>
</div>
<div class="section" id="complications">
<h2>Complications<a class="headerlink" href="#complications" title="Permalink to this headline">¶</a></h2>
<p>Some backends require more sophistication.  In principle we may want to do the
following:</p>
<ol class="arabic simple">
<li>Modify/optimize the expression tree for a given backend.
<tt class="docutils literal"><span class="pre">optimize(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">expr</span></tt></li>
<li>Modify the data resources before we start execution.
<tt class="docutils literal"><span class="pre">pre_compute(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></li>
<li>Modify the data resources as they change type throughout the computation
<tt class="docutils literal"><span class="pre">pre_compute(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></li>
<li>Clean up the data result after we complete execution.
<tt class="docutils literal"><span class="pre">post_compute(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></li>
<li>Process a leaf of the tree in a bottom up fashion as described above.
<tt class="docutils literal"><span class="pre">compute_up(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></li>
<li>Process large chunks of the tree at once, rather than always start from the
bottom. <tt class="docutils literal"><span class="pre">compute_down(expr,</span> <span class="pre">data)</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt></li>
</ol>
<p>Each of these steps is critical to one backend or another.  We describe each in
turn and then give the complete picture of the entire pipeline.</p>
</div>
<div class="section" id="optimize-expr-data-expr">
<h2><tt class="docutils literal"><span class="pre">optimize</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">expr</span></tt><a class="headerlink" href="#optimize-expr-data-expr" title="Permalink to this headline">¶</a></h2>
<p>Optimize takes an expression and some data and changes the expression based on
the data type.</p>
<p>For example in columnar stores (like <tt class="docutils literal"><span class="pre">bcolz.ctable</span></tt>) we insert projections in
the expression to reduce the memory footprint.  In numpy-based array backends
we insert <tt class="docutils literal"><span class="pre">Broadcast</span></tt> operations to perform loop fusion.</p>
<p>This function is applied throughout the tree at the top-most point at which it
is applicable.  It is not applied at leaves which have little to optimize.</p>
</div>
<div class="section" id="pre-compute-expr-data-data">
<h2><tt class="docutils literal"><span class="pre">pre_compute</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt><a class="headerlink" href="#pre-compute-expr-data-data" title="Permalink to this headline">¶</a></h2>
<p>Pre-compute is applied to leaf data elements prior to computation
(<tt class="docutils literal"><span class="pre">xdata</span></tt> and <tt class="docutils literal"><span class="pre">ydata</span></tt> in the example above).  It might be used for example,
to load data into memory.</p>
<p>We apply <tt class="docutils literal"><span class="pre">pre_compute</span></tt> at two stages of the pipeline</p>
<ol class="arabic simple">
<li>At the beginning of the computation</li>
<li>Any time that the data significantly <em>changes type</em></li>
</ol>
<p>So for example for the dataset:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;my_foo&#39;</span><span class="p">:</span>  <span class="n">Foo</span><span class="p">(</span><span class="o">...</span><span class="p">)}</span>
</pre></div>
</div>
<p>If we apply the computation:</p>
<div class="highlight-python"><div class="highlight"><pre>X -&gt; X.my_foo.distinct()
</pre></div>
</div>
<p>Then after the <tt class="docutils literal"><span class="pre">X</span> <span class="pre">-&gt;</span> <span class="pre">X.my_foo</span></tt> computation as the type changes from <tt class="docutils literal"><span class="pre">dict</span></tt>
to <tt class="docutils literal"><span class="pre">Foo</span></tt> we will call <tt class="docutils literal"><span class="pre">pre_compute</span></tt> again on the <tt class="docutils literal"><span class="pre">Foo</span></tt> object with the
remaining expression:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">pre_compute</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">my_foo</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="n">Foo</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<p>A real use case is the streaming Python backend which consumes either sequences
of tuples or sequences of dicts.  <tt class="docutils literal"><span class="pre">precompute(expr,</span> <span class="pre">Sequence)</span></tt> detects which
case we are in and normalizes to sequences of tuples.  This pre-computation
allows the rest of the Python backend to make useful assumptions.</p>
<p>Another use case is computation on CSV files.  If the csv file is small we&#8217;d
like to transform it into a pandas dataframe.  If it is large we&#8217;d like to
transform it into a Python iterator.  This logic can be encoded as a
<tt class="docutils literal"><span class="pre">pre_compute</span></tt> function and so will be triggered whenever a <tt class="docutils literal"><span class="pre">CSV</span></tt> object is
first found.</p>
</div>
<div class="section" id="post-compute-expr-data-data">
<h2><tt class="docutils literal"><span class="pre">post_compute</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt><a class="headerlink" href="#post-compute-expr-data-data" title="Permalink to this headline">¶</a></h2>
<p>Post-compute finishes a computation.  It is handed the data after all
computation has been done.</p>
<p>For example, in the case of SQLAlchemy queries the <tt class="docutils literal"><span class="pre">post_compute</span></tt> function
actually sends the query to the SQL engine and collects results.  This occurs
only after Blaze finishes translating everything.</p>
</div>
<div class="section" id="compute-up-expr-data-data">
<h2><tt class="docutils literal"><span class="pre">compute_up</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt><a class="headerlink" href="#compute-up-expr-data-data" title="Permalink to this headline">¶</a></h2>
<p>Compute up walks the expression tree bottom up and processes data step by step.</p>
<p>Compute up is the most prolific function in the computation pipeline and
encodes most of the logic.  A brief example</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@dispatch</span><span class="p">(</span><span class="n">blaze</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Add</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_up</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">+</span> <span class="n">rhs</span>
</pre></div>
</div>
</div>
<div class="section" id="compute-down-expr-data-data">
<h2><tt class="docutils literal"><span class="pre">compute_down</span> <span class="pre">::</span> <span class="pre">expr,</span> <span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">data</span></tt><a class="headerlink" href="#compute-down-expr-data-data" title="Permalink to this headline">¶</a></h2>
<p>In some cases we want to process large chunks of the expression tree at once.
Compute-down operates on the tree top-down, being given the root node / full
expression first, and proceeding down the tree while it can not find a match.</p>
<p>Compute-down is less common than compute-up.  It is most often used when one
backend wants to ship an entire expression over to another.  This is done, for
example, in the SparkSQL backend in which we take the entire expression and
execute it against a SQL backend, and then finally apply that computation onto
the SchemaRDD.</p>
<p>It is also used extensively in backends that leverage chunking.  These backends
want to process a large part of the expression tree at once.</p>
</div>
<div class="section" id="full-pipeline">
<h2>Full Pipeline<a class="headerlink" href="#full-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The full pipeline looks like the following</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">Pre-compute</span></tt> all leaves of data</li>
<li><tt class="docutils literal"><span class="pre">Optimize</span></tt> the expression</li>
<li>Try calling <tt class="docutils literal"><span class="pre">compute_down</span></tt> on the entire expression tree</li>
<li>Otherwise, traverse up the tree from the leaves, calling <tt class="docutils literal"><span class="pre">compute_up</span></tt>.
Repeat this until the data significantly changes type (e.g. <tt class="docutils literal"><span class="pre">list</span></tt> to
<tt class="docutils literal"><span class="pre">int</span></tt> after a <tt class="docutils literal"><span class="pre">sum</span></tt> operation)</li>
<li>Reevaluate <tt class="docutils literal"><span class="pre">optimize</span></tt> on the expression and <tt class="docutils literal"><span class="pre">pre_compute</span></tt> on all of the
data elements.</li>
</ol>
<p>6.  Go to step 3
5.  Call <tt class="docutils literal"><span class="pre">post_compute</span></tt> on the result</p>
<p>This is outlined in <tt class="docutils literal"><span class="pre">blaze/compute/core.py</span></tt> in the functions <tt class="docutils literal"><span class="pre">compute(Expr,</span>
<span class="pre">dict)</span></tt> and <tt class="docutils literal"><span class="pre">top_then_bottom_then_top_again_etc</span></tt>.</p>
</div>
<div class="section" id="history">
<h2>History<a class="headerlink" href="#history" title="Permalink to this headline">¶</a></h2>
<p>This design is ad-hoc.  Each of the stages listed above arose from need, not
from principled fore-thought.  Undoubtedly this system could be improved.  In
particular much of the complexity comes from the fact that <tt class="docutils literal"><span class="pre">compute_up/down</span></tt>
functions may transform our data arbitrarily.  This, along with various
particular needs from all of the different data types, forces the
flip-flopping between top-down and bottom-up traversals.  Please note that
while this strategy <em>works well most of the time</em> pathalogical cases do exist.</p>
</div>
</div>


      </div>
  </div>
</div>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-27761864-10', 'auto');
    ga('send', 'pageview');
    </script>
  </body>
</html>