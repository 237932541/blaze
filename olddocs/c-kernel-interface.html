
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Blaze Kernel C Interface &mdash; Blaze 0.1-dev documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap-2.2.1.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/bootstrap-responsive-2.2.1.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-2.2.1.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-scrollspy.js"></script>
    <script type="text/javascript" src="_static/js/bootstrap-affix.js"></script>
    <link rel="top" title="Blaze 0.1-dev documentation" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

<div class="container">
  <!-- This is copied from /web, find better solution -->
  <div class="masthead">
    <ul class="nav nav-pills pull-right">
        <li>
            <a href="/index.html"><i class="icon-home"></i> Blaze</a>
        </li>
        
        <li class="active">
            <a href="/docs/index.html"><i class="icon-book"></i> Documentation</a>
        </li>
        
        <li>
            <a href="/examples.html"><i class="icon-ok"></i> Examples</a>
        </li>
        
        <li>
            <a href="http://github.com/ContinuumIO/blaze-core"><i class="icon-download"></i> Source</a>
        </li>
        
        <li>
            <a href="/vision.html"><i class="icon-star"></i> Vision</a>
        </li>
        
        <li>
            <a href="/people.html"><i class="icon-user"></i> People</a>
        </li>
        
        <li>
            <a href="http://groups.google.com/a/continuum.io/forum/#!forum/blaze-dev"><i class="icon-envelope"></i> Mailing List</a>
        </li>
    </ul>
    <h3 class="muted"><img src="_static/img/logo.png">Blaze</h3>
  </div>

  <hr>

  <div class="row">
      <div class="span3">
         <ul id="nav" class="nav nav-list" data-spy="affix" data-offset-top="200"><li><a href="index.html"><b>Index</b></a></li>
<ul>
<li><a class="reference internal" href="#">Blaze Kernel C Interface</a><ul>
<li><a class="reference internal" href="#interface-goals">Interface Goals</a></li>
<li><a class="reference internal" href="#kernel-definition">Kernel Definition</a></li>
<li><a class="reference internal" href="#dynamic-kernel-instance">Dynamic Kernel Instance</a></li>
<li><a class="reference internal" href="#example-usage">Example Usage</a></li>
<li><a class="reference internal" href="#example-kernel-factories">Example Kernel Factories</a></li>
</ul>
</li>
</ul>

         </ul>
      </div>
      <div class="span9">
          
  <div class="section" id="blaze-kernel-c-interface">
<h1>Blaze Kernel C Interface<a class="headerlink" href="#blaze-kernel-c-interface" title="Permalink to this headline">¶</a></h1>
<p>This is a draft specification for a low level kernel
interface ABI. The purpose of this interface is for
third-party code to build kernels for blaze, and for
blaze to build kernels usable by third-party code.
This is a work in progress, if you would like to
discuss this design, please email the public blaze
development mailing list at <a class="reference external" href="mailto:blaze-dev&#37;&#52;&#48;continuum&#46;io">blaze-dev<span>&#64;</span>continuum<span>&#46;</span>io</a></p>
<div class="section" id="interface-goals">
<h2>Interface Goals<a class="headerlink" href="#interface-goals" title="Permalink to this headline">¶</a></h2>
<p>The goals of this interface are:</p>
<blockquote>
<div><ul class="simple">
<li>To communicate low level executable kernels between
Blaze, DyND, Numba, and other third-party library code.
Third-party code shouldn&#8217;t have to have a deep
understanding of the blaze system to provide
or consume kernels.</li>
<li>To allow safe, correct usage across any ABI boundary,
i.e. to not rely on linking to a particular C/C++
standard library, the Python API, a common blaze API, etc.</li>
<li>To allow thread-safe execution. An execution engine
should be able to call any kernel following this
specification at the same time on many different threads.</li>
</ul>
</div></blockquote>
<p>This interface provides a common denominator binary ABI
format for kernels, similar to how &#8216;.o&#8217; or &#8216;.obj&#8217; files
provide a format for compiled code before it gets linked
together.</p>
</div>
<div class="section" id="kernel-definition">
<h2>Kernel Definition<a class="headerlink" href="#kernel-definition" title="Permalink to this headline">¶</a></h2>
<p>A blaze kernel is a chunk of memory which begins with
two function pointers, a kernel function pointer and a
destructor. This is followed by an arbitrary amount of
additional memory owned by the kernel.</p>
<p>The kernel function prototype is context-specific,
it must be known by the caller from separate information.
It may be known because the kernel is the result of
a request for a specific kind of assignment kernel, or
for a binary predicate, for example.</p>
<p>The memory of a blaze kernel must satisfy the following
restrictions:</p>
<blockquote>
<div><ul class="simple">
<li>Its alignment must be that of a pointer, i.e.
4 on 32-bit platforms and 8 on 64-bit platforms.</li>
<li>Its total size must be divisible by the alignment.</li>
<li>It must be relocatable using a memcpy.<ul>
<li>It cannot contain pointers to other
locations within itself (must use offsets for this).</li>
<li>It cannot assume an address within its memory
is aligned greater than pointer alignment, because
other code could memcpy it to a location which
changes that alignment.</li>
</ul>
</li>
</ul>
</div></blockquote>
<p>As a C struct, this looks like:</p>
<div class="highlight-python"><pre>struct kernel_data_prefix;
typedef void (*destructor_fn_t)(kernel_data_prefix *);

struct kernel_data_prefix {
    void *function;
    destructor_fn_t destructor;
};

struct kernel_data {
    kernel_data_prefix base;
    /* Additional kernel data... */
};</pre>
</div>
<p>An example kernel function prototype is a single assignment kernel,
which assigns one value from a source memory location
to a destination.:</p>
<div class="highlight-python"><pre>typedef void (*unary_single_operation_t)(
                char *dst, const char *src,
                kernel_data_prefix *extra);</pre>
</div>
</div>
<div class="section" id="dynamic-kernel-instance">
<h2>Dynamic Kernel Instance<a class="headerlink" href="#dynamic-kernel-instance" title="Permalink to this headline">¶</a></h2>
<p>Blaze kernels may be allocated on the stack or the heap,
but for communicating kernels across library boundaries,
a standard way to pass the kernel and memory allocation
information is needed.:</p>
<div class="highlight-python"><pre>struct dynamic_kernel_instance {
    kernel_data_prefix *kernel;
    size_t kernel_size;
    void (*free_func)(void *);
};</pre>
</div>
<p>In this structure, &#8216;kernel&#8217; is a pointer to the
kernel object as described above, &#8216;kernel_size&#8217;
is the size of the data held in the kernel, and
&#8216;free_func&#8217; is the function to call for deallocating
the memory &#8216;kernel&#8217; points to. By providing this function
explicitly, different libraries can use different
memory subsystems without any linking incompatibilities.</p>
</div>
<div class="section" id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>Here&#8217;s a simple example of how third-party C code might call
the Blaze API to get a kernel, call the kernel, and free
the kernel data.:</p>
<div class="highlight-python"><pre>/* Blaze API function that returns a unary single kernel */
int blaze_get_some_kernel_function(...,
                dynamic_kernel_instance *out_kernel);

int apply_blaze_kernel(char *dst, const char *src, ...)
{
    dynamic_kernel_instance k;
    unary_single_operation_t kfunc;

    /* Request a kernel from blaze */
    if (blaze_get_some_kernel_function(..., &amp;k) &lt; 0) {
        /* propagate error */
        return -1;
    }

    /* Get the kernel function pointer and call it */
    kfunc = (unary_single_operation_t)k.kernel-&gt;function;
    kfunc(dst, src, k.kernel)

    /* To free the kernel, we must destruct it AND free its memory */
    k.kernel-&gt;destructor(k.kernel);
    k.free_func(k.kernel);

    /* return success */
    return 0;
}</pre>
</div>
</div>
<div class="section" id="example-kernel-factories">
<h2>Example Kernel Factories<a class="headerlink" href="#example-kernel-factories" title="Permalink to this headline">¶</a></h2>
<p>The proposed interface is almost exactly that used in DyND
presently. The documentation for kernels there provide some
examples of how kernels can be constructed and how a kernel
factory API might look:</p>
<p><a class="reference external" href="https://github.com/ContinuumIO/dynd/blob/master/documents/kernels.md">https://github.com/ContinuumIO/dynd/blob/master/documents/kernels.md</a></p>
</div>
</div>


      </div>
  </div>
</div>
  </body>
</html>